from io import StringIO
import pandas as pd




from src.data_processing import calculate_pnl_2

# Sample data
data = """
datetime,symbol,side,price,qty,quoteQty,commission,commissionAsset,orderId
2025-01-04 23:00:22.312,CTXCUSDT,sell,0.3025,25.0,7.5625,7.93e-06,BNB,528538282
2025-01-04 23:00:22.312,CTXCUSDT,sell,0.3024,1505.0,455.112,0.00047754,BNB,528538282
2025-01-04 23:00:22.312,CTXCUSDT,sell,0.3024,386.0,116.7264,0.00012247,BNB,528538282
2025-01-04 23:00:22.312,CTXCUSDT,sell,0.3024,25.0,7.56,7.92e-06,BNB,528538282
2025-01-04 23:00:22.312,CTXCUSDT,sell,0.3023,386.0,116.6878,0.00012243,BNB,528538282
2025-01-04 23:00:22.312,CTXCUSDT,sell,0.3023,25.0,7.5575,7.92e-06,BNB,528538282
2025-01-04 23:00:22.312,CTXCUSDT,sell,0.3023,680.0,205.564,0.00021569,BNB,528538282
2025-01-04 23:00:22.312,CTXCUSDT,sell,0.3023,25.0,7.5575,7.92e-06,BNB,528538282
2025-01-04 23:00:22.312,CTXCUSDT,sell,0.3023,84.0,25.3932,2.664e-05,BNB,528538282
2025-01-04 23:00:22.312,CTXCUSDT,sell,0.3022,386.0,116.6492,0.0001224,BNB,528538282
2025-01-04 23:00:22.312,CTXCUSDT,sell,0.3022,25.0,7.555,7.92e-06,BNB,528538282
2025-01-04 23:00:22.312,CTXCUSDT,sell,0.3022,1856.0,560.8832,0.00058853,BNB,528538282
2025-01-04 23:00:22.312,CTXCUSDT,sell,0.3022,818.0,247.1996,0.00025938,BNB,528538282
2025-01-04 23:00:22.312,CTXCUSDT,sell,0.3021,164.0,49.5444,5.198e-05,BNB,528538282
2025-01-04 23:00:22.312,CTXCUSDT,sell,0.3021,20.0,6.042,6.33e-06,BNB,528538282
2025-01-04 23:00:22.312,CTXCUSDT,sell,0.3021,222.0,67.0662,7.037e-05,BNB,528538282
2025-01-04 23:00:22.312,CTXCUSDT,sell,0.3021,25.0,7.5525,7.92e-06,BNB,528538282
2025-01-04 23:00:22.312,CTXCUSDT,sell,0.3021,25.0,7.5525,7.92e-06,BNB,528538282
2025-01-04 23:00:22.312,CTXCUSDT,sell,0.3021,824.0,248.9304,0.0002612,BNB,528538282
2025-01-04 23:00:22.312,CTXCUSDT,sell,0.3021,417.0,125.9757,0.00013218,BNB,528538282
2025-01-04 23:00:22.312,CTXCUSDT,sell,0.3021,341.0,103.0161,0.00010809,BNB,528538282
2025-01-05 02:59:57.083,CTXCUSDT,buy,0.3314,1323.0,438.4422,0.00045693,BNB,528980792
2025-01-05 02:59:57.642,CTXCUSDT,buy,0.3314,18.0,5.9652,6.21e-06,BNB,528980792
2025-01-05 03:00:00.851,CTXCUSDT,buy,0.3314,750.0,248.55,0.00025902,BNB,528980792
2025-01-05 03:00:00.855,CTXCUSDT,buy,0.3314,2494.0,826.5116,0.00086136,BNB,528980792
2025-01-05 03:00:00.858,CTXCUSDT,buy,0.3314,1142.0,378.4588,0.00039441,BNB,528980792
2025-01-05 03:00:00.859,CTXCUSDT,buy,0.3314,2537.0,840.7618,0.00087621,BNB,528980792
2025-01-27 18:25:17.255,CTXCUSDT,sell,0.2414,990.0,238.986,0.00027175,BNB,540192323
2025-01-27 18:25:17.255,CTXCUSDT,sell,0.2414,32.0,7.7248,8.78e-06,BNB,540192323
2025-01-27 18:25:17.255,CTXCUSDT,sell,0.2414,32.0,7.7248,8.78e-06,BNB,540192323
2025-01-27 18:25:17.255,CTXCUSDT,sell,0.2413,32.0,7.7216,8.77e-06,BNB,540192323
2025-01-27 18:25:17.255,CTXCUSDT,sell,0.2413,32.0,7.7216,8.77e-06,BNB,540192323
2025-01-27 18:25:17.255,CTXCUSDT,sell,0.2413,152.0,36.6776,4.17e-05,BNB,540192323
2025-01-27 18:25:17.255,CTXCUSDT,sell,0.2413,1081.0,260.8453,0.00029661,BNB,540192323
2025-01-27 18:25:17.255,CTXCUSDT,sell,0.2412,32.0,7.7184,8.77e-06,BNB,540192323
2025-01-27 18:25:17.255,CTXCUSDT,sell,0.2412,990.0,238.788,0.00027153,BNB,540192323
2025-01-27 18:25:17.255,CTXCUSDT,sell,0.2412,32.0,7.7184,8.77e-06,BNB,540192323
2025-01-27 18:25:17.255,CTXCUSDT,sell,0.2412,982.0,236.8584,0.00026933,BNB,540192323
2025-01-27 18:25:17.255,CTXCUSDT,sell,0.2412,424.0,102.2688,0.00011628,BNB,540192323
2025-01-27 18:25:17.255,CTXCUSDT,sell,0.2412,152.0,36.6624,4.168e-05,BNB,540192323
2025-01-27 18:25:17.255,CTXCUSDT,sell,0.2412,990.0,238.788,0.00027153,BNB,540192323
2025-01-27 18:25:17.255,CTXCUSDT,sell,0.2411,32.0,7.7152,8.76e-06,BNB,540192323
2025-01-27 18:25:17.255,CTXCUSDT,sell,0.2411,976.0,235.3136,0.00026757,BNB,540192323
2025-01-27 18:25:17.255,CTXCUSDT,sell,0.2411,31.0,7.4741,8.49e-06,BNB,540192323
2025-01-27 18:25:17.255,CTXCUSDT,sell,0.2411,1027.0,247.6097,0.00028155,BNB,540192323
2025-01-27 20:00:12.639,CTXCUSDT,buy,0.2368,990.0,234.432,0.00026441,BNB,540335094
2025-01-27 20:00:12.639,CTXCUSDT,buy,0.2368,32.0,7.5776,8.54e-06,BNB,540335094
2025-01-27 20:00:12.639,CTXCUSDT,buy,0.2368,32.0,7.5776,8.54e-06,BNB,540335094
2025-01-27 20:00:12.639,CTXCUSDT,buy,0.2369,32.0,7.5808,8.54e-06,BNB,540335094
2025-01-27 20:00:12.639,CTXCUSDT,buy,0.2369,32.0,7.5808,8.54e-06,BNB,540335094
2025-01-27 20:00:12.639,CTXCUSDT,buy,0.2369,282.0,66.8058,7.531e-05,BNB,540335094
2025-01-27 20:00:12.639,CTXCUSDT,buy,0.237,32.0,7.584,8.54e-06,BNB,540335094
2025-01-27 20:00:12.639,CTXCUSDT,buy,0.237,32.0,7.584,8.54e-06,BNB,540335094
2025-01-27 20:00:12.639,CTXCUSDT,buy,0.237,282.0,66.834,7.531e-05,BNB,540335094
2025-01-27 20:00:12.639,CTXCUSDT,buy,0.237,519.0,123.003,0.00013861,BNB,540335094
2025-01-27 20:00:12.639,CTXCUSDT,buy,0.2371,32.0,7.5872,8.54e-06,BNB,540335094
2025-01-27 20:00:12.639,CTXCUSDT,buy,0.2371,32.0,7.5872,8.54e-06,BNB,540335094
2025-01-27 20:00:12.639,CTXCUSDT,buy,0.2371,519.0,123.0549,0.00013861,BNB,540335094
2025-01-27 20:00:12.639,CTXCUSDT,buy,0.2371,164.0,38.8844,4.38e-05,BNB,540335094
2025-01-27 20:00:12.639,CTXCUSDT,buy,0.2372,32.0,7.5904,8.54e-06,BNB,540335094
2025-01-27 20:00:12.639,CTXCUSDT,buy,0.2372,32.0,7.5904,8.54e-06,BNB,540335094
2025-01-27 20:00:12.639,CTXCUSDT,buy,0.2372,518.0,122.8696,0.00013835,BNB,540335094
2025-01-27 20:00:12.639,CTXCUSDT,buy,0.2372,164.0,38.9008,4.38e-05,BNB,540335094
2025-01-27 20:00:12.639,CTXCUSDT,buy,0.2373,32.0,7.5936,8.54e-06,BNB,540335094
2025-01-27 20:00:12.639,CTXCUSDT,buy,0.2373,32.0,7.5936,8.54e-06,BNB,540335094
2025-01-27 20:00:12.639,CTXCUSDT,buy,0.2373,424.0,100.6152,0.00011324,BNB,540335094
2025-01-27 20:00:12.639,CTXCUSDT,buy,0.2373,518.0,122.9214,0.00013835,BNB,540335094
2025-01-27 20:00:12.639,CTXCUSDT,buy,0.2373,400.0,94.92,0.00010683,BNB,540335094
2025-01-27 20:00:12.639,CTXCUSDT,buy,0.2373,164.0,38.9172,4.38e-05,BNB,540335094
2025-01-27 20:00:12.639,CTXCUSDT,buy,0.2374,32.0,7.5968,8.54e-06,BNB,540335094
2025-01-27 20:00:12.639,CTXCUSDT,buy,0.2374,32.0,7.5968,8.54e-06,BNB,540335094
2025-01-27 20:00:12.639,CTXCUSDT,buy,0.2374,990.0,235.026,0.00026441,BNB,540335094
2025-01-27 20:00:12.639,CTXCUSDT,buy,0.2374,518.0,122.9732,0.00013835,BNB,540335094
2025-01-27 20:00:12.639,CTXCUSDT,buy,0.2374,1013.0,240.4862,0.00027055,BNB,540335094
2025-01-27 20:00:12.639,CTXCUSDT,buy,0.2375,32.0,7.6,8.54e-06,BNB,540335094
2025-01-27 20:00:12.639,CTXCUSDT,buy,0.2375,32.0,7.6,8.54e-06,BNB,540335094
2025-01-27 20:00:12.639,CTXCUSDT,buy,0.2375,42.0,9.975,1.121e-05,BNB,540335094
2025-02-07 19:50:06.334,CTXCUSDT,sell,0.1809,2098.0,379.5282,0.00048902,BNB,544635348
2025-02-07 19:50:08.755,CTXCUSDT,sell,0.1809,1350.0,244.215,0.00031467,BNB,544635348
2025-02-07 19:50:08.955,CTXCUSDT,sell,0.1809,33.0,5.9697,7.68e-06,BNB,544635348
2025-02-07 19:50:09.755,CTXCUSDT,sell,0.1809,363.0,65.6667,8.46e-05,BNB,544635348
2025-02-07 19:50:13.888,CTXCUSDT,sell,0.1807,7337.0,1325.7959,0.00170829,BNB,544635481
2025-02-07 20:07:06.683,CTXCUSDT,buy,0.1746,11181.0,1952.2026,0.00251932,BNB,544668266
2025-02-08 01:40:17.185,CTXCUSDT,sell,0.1871,243.0,45.4653,5.903e-05,BNB,544921676
2025-02-08 01:40:17.185,CTXCUSDT,sell,0.1871,97.0,18.1487,2.356e-05,BNB,544921676
2025-02-08 01:40:17.185,CTXCUSDT,sell,0.187,243.0,45.441,5.9e-05,BNB,544921676
2025-02-08 01:40:17.185,CTXCUSDT,sell,0.1869,1070.0,199.983,0.00025967,BNB,544921676
2025-02-08 01:40:17.185,CTXCUSDT,sell,0.1869,148.0,27.6612,3.591e-05,BNB,544921676
2025-02-08 01:40:17.185,CTXCUSDT,sell,0.1869,41.0,7.6629,9.94e-06,BNB,544921676
2025-02-08 01:40:17.185,CTXCUSDT,sell,0.1869,41.0,7.6629,9.94e-06,BNB,544921676
2025-02-08 01:40:17.185,CTXCUSDT,sell,0.1869,78.0,14.5782,1.892e-05,BNB,544921676
2025-02-08 01:40:17.185,CTXCUSDT,sell,0.1868,41.0,7.6588,9.93e-06,BNB,544921676
2025-02-08 01:40:17.185,CTXCUSDT,sell,0.1868,41.0,7.6588,9.93e-06,BNB,544921676
2025-02-08 01:40:17.185,CTXCUSDT,sell,0.1868,197.0,36.7996,4.778e-05,BNB,544921676
2025-02-08 01:40:17.185,CTXCUSDT,sell,0.1867,547.0,102.1249,0.0001326,BNB,544921676
2025-02-08 01:40:17.185,CTXCUSDT,sell,0.1867,41.0,7.6547,9.93e-06,BNB,544921676
2025-02-08 01:40:17.185,CTXCUSDT,sell,0.1867,41.0,7.6547,9.93e-06,BNB,544921676
2025-02-08 01:40:17.185,CTXCUSDT,sell,0.1867,358.0,66.8386,8.678e-05,BNB,544921676
2025-02-08 01:40:17.185,CTXCUSDT,sell,0.1867,112.0,20.9104,2.715e-05,BNB,544921676
2025-02-08 01:40:17.185,CTXCUSDT,sell,0.1867,198.0,36.9666,4.8e-05,BNB,544921676
2025-02-08 01:40:17.185,CTXCUSDT,sell,0.1867,108.0,20.1636,2.617e-05,BNB,544921676
2025-02-08 01:40:17.185,CTXCUSDT,sell,0.1866,41.0,7.6506,9.93e-06,BNB,544921676
2025-02-08 01:40:17.185,CTXCUSDT,sell,0.1866,41.0,7.6506,9.93e-06,BNB,544921676
2025-02-08 01:40:17.185,CTXCUSDT,sell,0.1866,198.0,36.9468,4.797e-05,BNB,544921676
2025-02-08 01:40:17.185,CTXCUSDT,sell,0.1866,679.0,126.7014,0.00016452,BNB,544921676
2025-02-08 01:40:17.185,CTXCUSDT,sell,0.1865,41.0,7.6465,9.92e-06,BNB,544921676
2025-02-08 01:40:17.185,CTXCUSDT,sell,0.1865,41.0,7.6465,9.92e-06,BNB,544921676
2025-02-08 01:40:17.185,CTXCUSDT,sell,0.1865,198.0,36.927,4.794e-05,BNB,544921676
2025-02-08 01:40:17.185,CTXCUSDT,sell,0.1865,679.0,126.6335,0.00016443,BNB,544921676
2025-02-08 01:40:17.185,CTXCUSDT,sell,0.1864,197.0,36.7208,4.767e-05,BNB,544921676
2025-02-08 01:40:17.185,CTXCUSDT,sell,0.1864,41.0,7.6424,9.92e-06,BNB,544921676
2025-02-08 01:40:17.185,CTXCUSDT,sell,0.1864,41.0,7.6424,9.92e-06,BNB,544921676
2025-02-08 01:40:17.185,CTXCUSDT,sell,0.1864,33.0,6.1512,7.98e-06,BNB,544921676
2025-02-08 01:40:17.185,CTXCUSDT,sell,0.1864,547.0,101.9608,0.00013239,BNB,544921676
2025-02-08 01:40:17.185,CTXCUSDT,sell,0.1863,80.0,14.904,1.935e-05,BNB,544921676
2025-02-08 01:40:17.185,CTXCUSDT,sell,0.1863,197.0,36.7011,4.765e-05,BNB,544921676
2025-02-08 01:40:17.185,CTXCUSDT,sell,0.1863,41.0,7.6383,9.91e-06,BNB,544921676
2025-02-08 01:40:17.185,CTXCUSDT,sell,0.1863,41.0,7.6383,9.91e-06,BNB,544921676
2025-02-08 01:40:17.185,CTXCUSDT,sell,0.1863,679.0,126.4977,0.00016425,BNB,544921676
2025-02-08 01:40:17.185,CTXCUSDT,sell,0.1862,41.0,7.6342,9.9e-06,BNB,544921676
2025-02-08 01:40:17.185,CTXCUSDT,sell,0.1862,41.0,7.6342,9.9e-06,BNB,544921676
2025-02-08 01:40:17.185,CTXCUSDT,sell,0.1862,547.0,101.8514,0.00013224,BNB,544921676
2025-02-08 01:40:17.185,CTXCUSDT,sell,0.1862,198.0,36.8676,4.786e-05,BNB,544921676
2025-02-08 01:40:17.185,CTXCUSDT,sell,0.1862,537.0,99.9894,0.00012983,BNB,544921676
2025-02-08 01:40:17.185,CTXCUSDT,sell,0.1862,336.0,62.5632,8.123e-05,BNB,544921676
2025-02-08 01:40:17.185,CTXCUSDT,sell,0.1861,41.0,7.6301,9.9e-06,BNB,544921676
2025-02-08 01:40:17.185,CTXCUSDT,sell,0.1861,41.0,7.6301,9.9e-06,BNB,544921676
2025-02-08 01:40:17.185,CTXCUSDT,sell,0.1861,197.0,36.6617,4.76e-05,BNB,544921676
2025-02-08 01:40:17.185,CTXCUSDT,sell,0.1861,679.0,126.3619,0.00016407,BNB,544921676
2025-02-08 01:40:17.185,CTXCUSDT,sell,0.186,41.0,7.626,9.9e-06,BNB,544921676
2025-02-08 01:40:17.185,CTXCUSDT,sell,0.186,50.0,9.3,1.207e-05,BNB,544921676
2025-02-08 01:40:17.185,CTXCUSDT,sell,0.186,60.0,11.16,1.449e-05,BNB,544921676
2025-02-08 01:40:17.185,CTXCUSDT,sell,0.186,547.0,101.742,0.0001321,BNB,544921676
2025-02-08 01:40:17.185,CTXCUSDT,sell,0.186,41.0,7.626,9.9e-06,BNB,544921676
2025-02-08 01:40:17.185,CTXCUSDT,sell,0.186,197.0,36.642,4.757e-05,BNB,544921676
2025-02-08 01:40:17.185,CTXCUSDT,sell,0.186,129.0,23.994,3.115e-05,BNB,544921676
2025-02-08 05:40:04.850,CTXCUSDT,buy,0.1967,1751.0,344.4217,0.00044727,BNB,545176320
2025-02-08 05:40:04.850,CTXCUSDT,buy,0.1967,3009.0,591.8703,0.00076862,BNB,545176320
2025-02-08 05:40:04.850,CTXCUSDT,buy,0.1968,39.0,7.6752,9.96e-06,BNB,545176320
2025-02-08 05:40:04.850,CTXCUSDT,buy,0.1968,1440.0,283.392,0.00036783,BNB,545176320
2025-02-08 05:40:04.850,CTXCUSDT,buy,0.1968,650.0,127.92,0.00016603,BNB,545176320
2025-02-08 05:40:04.850,CTXCUSDT,buy,0.1968,39.0,7.6752,9.96e-06,BNB,545176320
2025-02-08 05:40:04.850,CTXCUSDT,buy,0.1968,110.0,21.648,2.809e-05,BNB,545176320
2025-02-08 05:40:04.850,CTXCUSDT,buy,0.1969,39.0,7.6791,9.96e-06,BNB,545176320
2025-02-08 05:40:04.850,CTXCUSDT,buy,0.1969,39.0,7.6791,9.96e-06,BNB,545176320
2025-02-08 05:40:04.850,CTXCUSDT,buy,0.1969,645.0,127.0005,0.00016476,BNB,545176320
2025-02-08 05:40:04.850,CTXCUSDT,buy,0.1969,650.0,127.985,0.00016603,BNB,545176320
2025-02-08 05:40:04.850,CTXCUSDT,buy,0.197,39.0,7.683,9.96e-06,BNB,545176320
2025-02-08 05:40:04.850,CTXCUSDT,buy,0.197,39.0,7.683,9.96e-06,BNB,545176320
2025-02-08 05:40:04.850,CTXCUSDT,buy,0.197,57.0,11.229,1.455e-05,BNB,545176320
2025-02-08 05:40:04.850,CTXCUSDT,buy,0.197,47.0,9.259,1.2e-05,BNB,545176320
2025-02-08 05:40:04.850,CTXCUSDT,buy,0.197,647.0,127.459,0.00016527,BNB,545176320
2025-02-08 05:40:04.850,CTXCUSDT,buy,0.197,91.0,17.927,2.324e-05,BNB,545176320
2025-02-08 05:40:04.850,CTXCUSDT,buy,0.197,650.0,128.05,0.00016603,BNB,545176320
2025-02-08 05:40:04.850,CTXCUSDT,buy,0.197,508.0,100.076,0.00012975,BNB,545176320
2025-02-08 05:40:04.850,CTXCUSDT,buy,0.1971,643.0,126.7353,0.00016424,BNB,545176320
2025-02-08 05:40:04.850,CTXCUSDT,buy,0.1971,39.0,7.6869,9.96e-06,BNB,545176320
2025-02-08 05:40:04.850,CTXCUSDT,buy,0.1971,12.0,2.3652,3.06e-06,BNB,545176320
"""


def test_calculate_fifo_pnl_totals():
    trades = pd.read_csv(StringIO(data))

    result,result_summary = calculate_pnl_2(trades)

    # Check expected totals
    assert result['qty'].sum() == 77294.0
    assert abs(result['profit'].sum() + 255.6037) < 1e-6  # allow small FP error
    assert abs(result['commission_bnb'].sum() - 0.0205031799) < 1e-10



def test_calculate_fifo_pnl_totals_fail():
    trades = pd.read_csv(StringIO(data))

    result,result_summary = calculate_pnl_2(trades)

    # Intentionally incorrect expected values
    assert result['qty'].sum() != 38647.0 + 1
    assert not abs(result['profit'].sum() + 255.6037 + 0.1) < 1e-6
    assert not abs(result['commission_bnb'].sum() - (0.0205031799 + 0.01)) < 1e-10
